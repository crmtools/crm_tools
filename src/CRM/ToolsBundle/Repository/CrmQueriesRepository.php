<?php

namespace CRM\ToolsBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * CrmQueriesRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CrmQueriesRepository extends EntityRepository
{

    public function getGroupsNameUcr(){
        $sqlGrpName = "SELECT DISTINCT groupName from crm_queries WHERE pageName = 'ucr_error_analysis'";
        $em = $this->getEntityManager();
        $query = $em->getConnection()->prepare($sqlGrpName);
        $query->execute();
        $groupsName = $query->fetchAll();
        return $groupsName;
    }

    public function getGroupsNamePick(){
        $sqlGrpName = "SELECT DISTINCT groupName from crm_queries WHERE pageName = 'pick_error_analysis'";
        $em = $this->getEntityManager();
        $query = $em->getConnection()->prepare($sqlGrpName);
        $query->execute();
        $groupsName = $query->fetchAll();
        return $groupsName;
    }

    public function getQueryFromCrmWheather($nbr){

        $queriesCrmWeather= array();
        $sql= "SELECT queryName, queryText FROM crm_queries where pageName='crm_weather'";

        $em = $this->getEntityManager();
        $query = $em->getConnection()->prepare($sql);
        $query->execute();
        $queries = $query->fetchAll();

        $queryTotalCompaigns['queryName'] = $queries[$nbr]['queryName'];
        $queryTotalCompaigns['queryText'] = $queries[$nbr]['queryText'];

        return $queryTotalCompaigns;
    }

    public function insertTheNewQueryIntoCrmQueries($queryText, $data, $groupName, $database, $user, $env)
    {

        $queryName = $data->getQueryName();
        $sql = "SELECT * FROM crm_queries WHERE queryName='" . $queryName . "';";

        $em = $this->getEntityManager();
        $query = $em->getConnection()->prepare($sql);
        $query->execute();
        $result = $query->fetchAll();

        if($result) {
            return false;
        } else {
            $enableHistory = $data->getEnableHistory();
            $description = $data->getDescription();

            if ($enableHistory == 'Yes') {
                $enableHistory = 1;
            } else {
                $enableHistory = 0;
            }

            if ($database == 'UCR') {
                $pageName = 'ucr_error_analysis';
            }else{
                $pageName = 'pick_error_analysis';
            }

            $date = new \DateTime();
            $date = $date->format('Y-m-d');

            $userId = $user->getId();

            $sql = "INSERT INTO crm_queries (queryName, queryText, groupName, pageName, enableHistory, connexion, description, dateCreate, dateModify, user_created, user_modified)
               VALUES ('$queryName', '$queryText', '$groupName', '$pageName',$enableHistory, '$env', '$description', '$date', '$date', $userId,$userId)";

            $em = $this->getEntityManager();
            $query = $em->getConnection()->prepare($sql);
            $query->execute();

            return true;
        }
    }

    public function getNewQuery($queryName){

        $sql= "SELECT id, queryName  FROM crm_queries WHERE queryName='".$queryName."';";

        $em = $this->getEntityManager();
        $query = $em->getConnection()->prepare($sql);
        $query->execute();
        $result = $query->fetchAll();

        return $result;
    }

    public function getResultWithSearchText($array_search_text){

        $array_result= null;
        foreach($array_search_text as $serche_text){
            $serche_text=trim($serche_text);

            $sql= "SELECT * FROM crm_queries WHERE queryName='$serche_text'";
            $em = $this->getEntityManager();
            $query = $em->getConnection()->prepare($sql);
            $query->execute();
            $result = $query->fetchAll();

            if(isset($result[0])){
                $array_result[]= $result[0];
            }
        }

        return $array_result;
    }

    public function modifyQueryIntoCrmQueries($queryText, $data, $groupName, $database, $user, $env, $result_id){

        $queryName = $data->getQueryName();

        $enableHistory = $data->getEnableHistory();
        $description = $data->getDescription();
        $description= str_replace("'","\'", $description);
        $userId = $user->getId();

        if ($enableHistory == 'Yes') {
            $enableHistory = 1;
        } else {
            $enableHistory = 0;
        }

        $date = new \DateTime();
        $date = $date->format('Y-m-d');

        $sql = "UPDATE crm_queries SET queryName= '$queryName', queryText = '$queryText', groupName= '$groupName', enableHistory ='$enableHistory', connexion ='$env', description= '$description', dateModify='$date',  user_modified= '$userId' WHERE id= $result_id";
        $em = $this->getEntityManager();
        $query = $em->getConnection()->prepare($sql);
        $query->execute();

        $sql= "SELECT queryName FROM crm_queries_result WHERE query_id = $result_id ";

        $em = $this->getEntityManager();
        $query = $em->getConnection()->prepare($sql);
        $query->execute();
        $result = $query->fetchAll();

        if($result){
            if($queryName != $result[0]["queryName"]){
                $sql= "UPDATE crm_queries_result SET queryName = '$queryName' WHERE query_id= $result_id ";

                $query = $em->getConnection()->prepare($sql);
                $query->execute();
            }
        }

        return true;
    }

    public function supprQueryInCrmQueries($query_id){

        $sql= "DELETE FROM crm_queries WHERE id = $query_id";

        $em = $this->getEntityManager();
        $query = $em->getConnection()->prepare($sql);
        $query->execute();

        return;
    }
}
